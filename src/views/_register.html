<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Register - Videl</title>
	<link rel="stylesheet" href="/styles.css">
</head>

<body class="bg-white min-h-screen">
	<!-- Navigation -->
	<nav class="fixed w-full z-20 top-0 left-0 border-b border-gray-200 bg-white/90 backdrop-blur-md">
		<div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4 px-4 sm:px-6 lg:px-8">
			<a href="#" class="flex items-center space-x-3">
				<span class="self-center text-xl sm:text-2xl font-semibold whitespace-nowrap text-orange-600">Videl</span>
			</a>
			<div class="flex md:order-2">
				<a href="#" class="bg-orange-600 text-white hover:bg-orange-700 focus:ring-4 focus:outline-none focus:ring-orange-300 font-medium rounded-lg text-xs sm:text-sm px-3 py-2 sm:px-4 sm:py-2 text-center">
					Get Started
				</a>
			</div>
		</div>
	</nav>

	<!-- Registration Section -->
	<div class="pt-16 sm:pt-24 bg-gradient-to-br from-orange-50 to-orange-100 min-h-screen flex items-center justify-center px-4 sm:px-6 lg:px-8">
		<div class="max-w-md w-full mx-auto bg-white rounded-xl shadow-2xl overflow-hidden p-6 sm:p-8">
			<h2 class="text-2xl sm:text-3xl font-extrabold text-center text-gray-900 mb-4 sm:mb-6">
				Create Your Account
			</h2>
			<form class="space-y-4 sm:space-y-6">
				<div>
					<label for="username" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
						Username
					</label>
					<div class="relative">
						<div class="absolute inset-y-0 left-0 pl-2 sm:pl-3 flex items-center pointer-events-none">
							<i data-lucide="user" class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400"></i>
						</div>
						<input name="username" type="text" id="username" required class="pl-8 sm:pl-10 block w-full px-2 py-1 sm:px-3 sm:py-2 text-xs sm:text-sm border border-gray-300 rounded-lg shadow-sm 
                            focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Choose a username">
					</div>
				</div>

				<div>
					<label for="email" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
						Email Address
					</label>
					<div class="relative">
						<div class="absolute inset-y-0 left-0 pl-2 sm:pl-3 flex items-center pointer-events-none">
							<i data-lucide="mail" class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400"></i>
						</div>
						<input name="email" type="email" id="email" required class="pl-8 sm:pl-10 block w-full px-2 py-1 sm:px-3 sm:py-2 text-xs sm:text-sm border border-gray-300 rounded-lg shadow-sm 
                            focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="you@example.com">
					</div>
				</div>

				<div>
					<label for="password" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
						Password
					</label>
					<div class="relative">
						<div class="absolute inset-y-0 left-0 pl-2 sm:pl-3 flex items-center pointer-events-none">
							<i data-lucide="lock" class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400"></i>
						</div>
						<input name="password" type="password" id="password" required class="pl-8 sm:pl-10 block w-full px-2 py-1 sm:px-3 sm:py-2 text-xs sm:text-sm border border-gray-300 rounded-lg shadow-sm 
                            focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Create a strong password">
					</div>
				</div>

				<div>
					<label for="confirm-password" class="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
						Confirm Password
					</label>
					<div class="relative">
						<div class="absolute inset-y-0 left-0 pl-2 sm:pl-3 flex items-center pointer-events-none">
							<i data-lucide="check-circle" class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400"></i>
						</div>
						<input name="cpassword" type="password" id="confirm-password" required class="pl-8 sm:pl-10 block w-full px-2 py-1 sm:px-3 sm:py-2 text-xs sm:text-sm border border-gray-300 rounded-lg shadow-sm 
                            focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500" placeholder="Repeat your password">
					</div>
				</div>

				<div>
					<button id="submit" type="button" class="w-full flex justify-center py-2 sm:py-3 px-3 sm:px-4 text-xs sm:text-base border border-transparent rounded-lg shadow-sm font-medium text-white bg-orange-600 hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-500">
						Sign up
					</button>
				</div>

				<div class="text-center">
					<p class="mt-2 text-xs sm:text-sm text-gray-600">
						Already have an account?
						<a href="/auth/signin" class="font-medium text-orange-600 hover:text-orange-500">
							Log in
						</a>
					</p>
				</div>
			</form>

			<div class="mt-4 sm:mt-6">
				<div class="relative">
					<div class="absolute inset-0 flex items-center">
						<div class="w-full border-t border-gray-300"></div>
					</div>
					<div class="relative flex justify-center text-xs sm:text-sm">
						<span class="px-2 bg-white text-gray-500">
							Or continue with
						</span>
					</div>
				</div>

				<div class="mt-4 sm:mt-6 grid grid-cols-1 gap-3">
					<a href="#" class="w-full flex items-center justify-center py-2 sm:py-3 border border-gray-300 rounded-lg hover:bg-gray-50">
						<i data-lucide="github" class="w-4 h-4 sm:w-5 sm:h-5"></i>
					</a>
				</div>
			</div>
		</div>
	</div>

	<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
	<script type="text/javascript">
		import Dialog from '../utils/Dialog.js'

		document.addEventListener('DOMContentLoaded', () => {
			const form = document.querySelector('form');

			// Prevent default form submission immediately
			form.addEventListener('submit', function(event) {
				event.preventDefault();
				event.stopPropagation();
			}, { passive: false });

			const subBtn = document.getElementById('submit')
			subBtn.addEventListener('submit', async function(event) {
				// Multiple layers of prevention
				event.preventDefault();
				event.stopPropagation();
				event.stopImmediatePropagation();

				// Disable submit button to prevent multiple submissions
				const submitButton = this.querySelector('button[type="submit"]');
				if (submitButton) {
					submitButton.disabled = true;
					submitButton.classList.add('opacity-50', 'cursor-not-allowed');
				}

				// Clear any previous error messages
				clearErrors();

				// Get input elements
				const passwordInput = this.querySelector('input[name="password"]');
				const confirmPasswordInput = this.querySelector('input[name="cpassword"]');
				const emailInput = this.querySelector('input[name="email"]');
				const usernameInput = this.querySelector('input[name="username"]');

				// Validation checks
				const validations = [
					{ input: emailInput, validator: validateEmail, errorMessage: 'Invalid email format' },
					{ input: passwordInput, validator: validatePassword, errorMessage: 'Password must be at least 8 characters' },
					{ input: usernameInput, validator: validateUsername, errorMessage: 'Username must be 3-20 characters' }
        ];

				// Perform validations
				const errors = validations.filter(({ input, validator }) =>
					!validator(input.value.trim())
				);

				// Check if passwords match
				if (passwordInput.value.trim() !== confirmPasswordInput.value.trim()) {
					errors.push({ input: confirmPasswordInput, errorMessage: 'Passwords must match' });
				}

				// If there are validation errors, display them and stop submission
				if (errors.length > 0) {
					// Use Dialog for validation errors
					Dialog.show({
						title: 'Validation Error',
						message: errors[0].errorMessage || 'Please check your input',
						type: 'error'
					});

					// Highlight specific inputs
					errors.forEach(({ input, errorMessage }) => {
						displayError(input, errorMessage);
					});

					// Re-enable submit button
					if (submitButton) {
						submitButton.disabled = false;
						submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
					}

					return false;
				}

				try {
					// Prepare data for submission
					const userData = {
						email: emailInput.value.trim(),
						password: passwordInput.value.trim(),
						username: usernameInput.value.trim()
					};

					// Send registration request
					const response = await fetch('/auth/register', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json'
						},
						credentials: 'include',
						body: JSON.stringify(userData)
					});

					// Parse response
					const result = await response.json();

					// Handle different response statuses
					if (response.ok) {
						// Successful registration
						Dialog.show({
							title: 'Registration Successful',
							message: 'Your account has been created!',
							type: 'success',
							onConfirm: () => {
								this.reset();
								window.localStorage.setItem('uemail', JSON.stringify(userData.email));
								window.location.href = '/verification';
							}
						});
					} else {
						// Server returned an error
						throw new Error(result.message || 'Registration failed');
					}
				} catch (error) {
					// Display user-friendly error dialog
					Dialog.show({
						title: 'Registration Error',
						message: error.message || 'An unexpected error occurred',
						type: 'error'
					});
				} finally {
					// Re-enable submit button
					if (submitButton) {
						submitButton.disabled = false;
						submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
					}
				}

				// Explicitly return false to prevent any default submission
				return false;
			}, { passive: false });

			// Validation helper functions
			function validateEmail(email) {
				const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
				return emailRegex.test(email);
			}

			function validatePassword(password) {
				return password.length >= 8;
			}

			function validateUsername(username) {
				return username.length >= 3 && username.length <= 20;
			}

			// Error display functions
			function displayError(input, message) {
				let errorElement = input.nextElementSibling;
				if (!errorElement || !errorElement.classList.contains('error-message')) {
					errorElement = document.createElement('div');
					errorElement.classList.add('error-message', 'text-red-500', 'text-xs', 'mt-1');
					input.parentNode.insertBefore(errorElement, input.nextSibling);
				}

				errorElement.textContent = message;
				input.classList.add('border-red-500');
			}

			function clearErrors() {
				document.querySelectorAll('.error-message').forEach(el => el.remove());
				document.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));
			}
		});
	</script>
</body>

</html>